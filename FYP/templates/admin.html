<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styleAdmin.css') }}">
</head>
<body>
    <div class="container">
        <!-- Logout Button -->
        <form method="get" action="{{ url_for('index') }}">
            <button type="submit" class="logout-btn">Logout</button>
        </form>

        <!-- Add New User Form -->
        <h2>Add New User</h2>
        <form method="post">
            <input type="hidden" name="form_type" value="add_user">

            <label>Full Name:</label>
            <input type="text" name="full_name" required>

            <label>Email:</label>
            <input type="email" name="email" required>

            <label>Position:</label>
            <input type="text" name="position" required>

            <label>Level (0 = Admin, 1 = Level1, 2 = Level2):</label>
            <input type="number" name="level" min="0" max="2" required>

            <input type="submit" value="Add User">
        </form>

        <!-- SweetAlert for Flash Messages -->
        {% if message %}
        <script>
            Swal.fire({
                title: "{{ 'Success' if category == 'success' else 'Warning' if category == 'warning' else 'Error' }}",
                text: "{{ message }}",
                icon: "{{ category }}",
                confirmButtonText: 'OK'
            });
        </script>
        {% endif %}

        <button type="button" class="user-list-btn" onclick="toggleUserList()">User List</button>
    </div>

    <div id="userSidePanel" class="side-panel">
        <span class="close-btn" onclick="closeUserList()">&times;</span>
        <h2>Existing Users</h2>
        <div id="userList">
            {% for user in users %}
            <div class="user-item">
                <div class="user-info">
                    <div style="font-weight: bold; font-size: 1.1em;">{{ user.fullname }}</div>
                    <div><span style="font-weight: 600;">Email:</span> {{ user.email }}</div>
                    <div><span style="font-weight: 600;">Position:</span> {{ user.position }}</div>
                    <div><span style="font-weight: 600;">Level:</span> {{ user.level }}</div>
                </div>
                <div class="user-actions-row">
                    <button type="button" class="update-btn" 
                            data-user-id="{{ user.id }}"
                            data-fullname="{{ user.fullname }}"
                            data-email="{{ user.email }}"
                            data-position="{{ user.position }}"
                            data-level="{{ user.level }}"
                            onclick="showUpdateForm(this)">Update</button>
                    <button type="button" class="delete-btn" 
                            data-user-id="{{ user.id }}"
                            data-fullname="{{ user.fullname }}"
                            onclick="confirmDelete(this)">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div id="updateForm" style="display: none;">
            <h3>Update User</h3>
            <form method="post">
                <input type="hidden" name="form_type" value="update_user">
                <input type="hidden" name="user_id" id="edit_user_id">

                <label>Full Name:</label>
                <input type="text" name="edit_fullname" id="edit_fullname" required>

                <label>Email:</label>
                <input type="email" name="edit_email" id="edit_email" required>

                <label>Position:</label>
                <input type="text" name="edit_position" id="edit_position" required>

                <label>Level:</label>
                <input type="number" name="edit_level" id="edit_level" min="0" max="2" required>

                <input type="submit" value="Update User">
                <button type="button" onclick="showUserList()" class="cancel-btn">Cancel</button>
            </form>
        </div>
    </div>

    <script>
    function openUserList() {
        document.getElementById("userSidePanel").style.width = "400px";
        document.querySelector(".user-list-btn").classList.add("shifted");
    }
    function closeUserList() {
        document.getElementById("userSidePanel").style.width = "0";
        document.querySelector(".user-list-btn").classList.remove("shifted");
    }
    function toggleUserList() {
        var panel = document.getElementById("userSidePanel");
        if (panel.style.width === "400px") {
            closeUserList();
        } else {
            openUserList();
        }
    }
    
    function showUpdateForm(button) {
        document.getElementById("userList").style.display = "none";
        document.getElementById("updateForm").style.display = "block";
        
        document.getElementById("edit_user_id").value = button.getAttribute('data-user-id');
        document.getElementById("edit_fullname").value = button.getAttribute('data-fullname');
        document.getElementById("edit_email").value = button.getAttribute('data-email');
        document.getElementById("edit_position").value = button.getAttribute('data-position');
        document.getElementById("edit_level").value = button.getAttribute('data-level');
    }
    
    function showUserList() {
        document.getElementById("userList").style.display = "block";
        document.getElementById("updateForm").style.display = "none";
    }

    function confirmDelete(button) {
        const userId = button.getAttribute('data-user-id');
        const fullname = button.getAttribute('data-fullname');
        
        Swal.fire({
            title: 'Are you sure?',
            text: `Do you want to delete user "${fullname}"? This action cannot be undone.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Create and submit a form to delete the user
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("admin_bp.admin") }}';
                
                const formTypeInput = document.createElement('input');
                formTypeInput.type = 'hidden';
                formTypeInput.name = 'form_type';
                formTypeInput.value = 'delete_user';
                form.appendChild(formTypeInput);
                
                const userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'user_id';
                userIdInput.value = userId;
                form.appendChild(userIdInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    </script>
</body>
</html>
